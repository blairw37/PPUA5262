---
title: "Module 2- Pulse of the City"
author: "Blair Wong"
date: "2023-01-27"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(tidyverse)
library(forcats)
library(modelsummary)
library(formattable)
```

### Background

The Craigslist Postings data retrieved from [BARI](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/52WSPT) is comprised of two parts: listing-level data (`CRAIGSLIST.Listings.csv`), and listing data that has been aggregated across census tracts (`CRAIGSLIST.CT.csv`). This analysis will focus on `craigslist_listings`. 

```{r}
craigslist_listings<-read.csv('../dataverse_files/CRAIGSLIST.Listings.csv')
```

There are 205450 number of observations.
```{r}
count(craigslist_listings)
```

The variables within the data set are listed below:
```{r}
names(craigslist_listings)
```

To better understand the variables, we can investigate the classes of each variable.
```{r}
sapply(craigslist_listings, class)
```

It is worth nothing that `LISTING_MONTH` is a "character". In order to rank the months correctly later on in the analysis, we will have to convert `LISTING_MONTH` to a factor. Additionally, the `ALLOWS_CATS` and `ALLOWS_DOGS` variables are "integers" rather than logical variables. Still, both of these variables only contain 0's and 1's to indicate whether the listing allows pets or not.

As with the previous analysis in "Tell A Data Story", I will focus on listings that are located in Greater Boston. To do so, I created a list of Boston neighborhoods and filtered the listings that did not have a location in the list. After filtering, there are now 46436 listings.

```{r}
greater_boston_cities<- list('Allston','Back Bay','Bay Village','Beacon Hill','Brighton','Charlestown','Chinatown','Dorchester','Downtown','East Boston','Fenway-Kenmore','Hyde Park','Jamaica Plain','Mattapan','Mission Hill','North End','Roslindale','Roxbury','South Boston','South End','West End','West Roxbury', 'Wharf District','Cambridge','Somerville','Everett','Chelsea','Revere','Quincy','Watertown','Brookline')

craigslist_listings_subset<-craigslist_listings %>% filter(LOCATION!='',LOCATION %in% greater_boston_cities) %>% select(LISTING_ID,LISTING_YEAR,LISTING_MONTH,LOCATION,AREA_SQFT,PRICE)

count(craigslist_listings_subset)
```

### Methods

#### Price & Square Footage
To better understand the prices & square footage for the listings, we can generate a summary table to describe the basic statistical values of the data. Using the `modelsummary` package, we can see the number of unique values, percentage of missing values, mean, standard deviation, minimum, median, and maximum. The table also provides a histogram to show the distribution of the values as well.

```{r}
datasummary_skim(craigslist_listings_subset[c('PRICE','AREA_SQFT')])
```

Given that the lowest rental price is $70, and the lowest square footage is 0 square ft, we can conclude that there is some data that is skewing the results and should be excluded. Also, for `AREA_SQFT`, it appears as though 65% of listings are missing square footage information. Therefore, I will also filter out NA values from `AREA_SQFT`.

To determine what would be a reasonable cut off for price, we can filter to see how many listings are above a certain price. Since there is a significant jump from number of listings below $400 & $500, we can treat listings under $400 as outliers and exclude them.

```{r}
count(filter(craigslist_listings_subset, PRICE < 400))
count(filter(craigslist_listings_subset, PRICE < 500))

craigslist_listings_subset <- filter(craigslist_listings_subset, PRICE > 400)
```

Looking at the square footage more closely, we can see that the minimum is 0.0 square ft, and the maximum is 710940.0 square ft, both of which are not possible values. Similar to price, we can filter out the outliers. A quick glance at the histogram in the table shows that only a few values are significantly high, which means we can eliminate the maximum value. To determine where the cut off is, I compared the number of listings above 2,000, 3,000, and 4,000 square feet. Since there is a major jump between 2,000 square feet and 3,000 square feet, we can use 3,000 as the maximum cut off. For the minimum, I ensured that the listings had above 100 square footage. A new summary table is created below.

```{r}
count(filter(craigslist_listings_subset, AREA_SQFT > 4000))
count(filter(craigslist_listings_subset, AREA_SQFT > 3000))
count(filter(craigslist_listings_subset, AREA_SQFT > 2000))
craigslist_listings_subset <- filter(craigslist_listings_subset, AREA_SQFT < 3000)
craigslist_listings_subset <- filter(craigslist_listings_subset, AREA_SQFT > 100)

datasummary_skim(craigslist_listings_subset[c('PRICE', 'AREA_SQFT')])
```

#### Neighborhood Distribution

To see the data on a neighborhood level, I created a table containing the frequencies of each neighborhood by using the `formattable` package and sorted it by the most frequent to least frequent.

```{r}
location_df <- as.data.frame(table(craigslist_listings_subset$LOCATION))
location_df_sorted<-location_df[order(location_df$Freq, decreasing = TRUE),]
colnames(location_df_sorted)<-c("Neighborhood", "Frequency")
formattable(location_df_sorted, format="html")
```

A more effective way to view the data is through a bar graph as seen below.
```{r}
base<-ggplot(craigslist_listings_subset, aes(x=reorder(LOCATION, LOCATION, length)))
base + geom_bar() + xlab("Neighborhoods/Cities") + ylab("Count") + coord_flip()
```

#### Listing Dates

Similar to neighborhood distribution, I also created a table to display how many listings there were per month. To do this, I updated the `LISTING_MONTH` variable from a character type to a factor. This enabled me to then order the months chronologically rather than alphabetically.

```{r}
craigslist_listings_subset<-craigslist_listings_subset %>% mutate(LISTING_MONTH = factor(LISTING_MONTH, levels = c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December")))
per_month_df <- as.data.frame(table(craigslist_listings_subset$LISTING_MONTH))
per_month_df_sorted<-per_month_df[order(per_month_df$Var1),]
colnames(per_month_df_sorted)<-c("Month", "Frequency")
formattable(per_month_df_sorted, format="html")
```

Another way to view this data is through a bar graph as seen below. This bar graph also shows how many listings were in each year. 

```{r}
base<-ggplot(craigslist_listings_subset, aes(x=LISTING_MONTH))
base + geom_bar(aes(fill=as.factor(LISTING_YEAR))) + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) + labs(fill = "Listing Year") + xlab("Month") + ylab("Count")
```

#### Pets
Lastly, we can also see how many listings allow pets. I created a table for the `ALLOWS_DOGS` variable and for the `ALLOWS_CATS` variable. I also calculated and appended the percentage by dividing the frequency by the total frequency and multiplying by 100. Similar to neighborhood distribution and listing dates, I used the `formattable` package to create the tables.

```{r}
allows_dogs_df<-as.data.frame(table(craigslist_listings$ALLOWS_DOGS))
colnames(allows_dogs_df)<-c("AllowsDogs", "Frequency")
allows_dogs_df <- allows_dogs_df %>% mutate("Percentage (%)" = Frequency/sum(Frequency)*100)

formattable(allows_dogs_df, format="html")

allows_cats_df<-as.data.frame(table(craigslist_listings$ALLOWS_CATS))
colnames(allows_cats_df)<-c("AllowsCats", "Frequency")
allows_cats_df <- allows_cats_df %>% mutate("Percentage (%)" = Frequency/sum(Frequency)*100)

formattable(allows_cats_df, format="html")
```

To view the data graphically, I used the values above to make a pie chart for cats and dogs.

```{r echo=FALSE}
allows_dogs_df <- allows_dogs_df %>% mutate("Percentage" = Frequency/sum(Frequency))
allows_dogs_df <- allows_dogs_df %>% mutate("Labels" = Frequency/sum(Frequency)*100)

# ggplot(allows_dogs_df, aes(x = "", y = Percentage, fill = AllowsDogs)) + geom_bar(width = 1, stat = "identity") + coord_polar(theta = "y", start = 0) + geom_label(aes(label = Labels), position = position_stack(vjust = 0.5)) + labs(title = "Allows Dogs", fill = "Allows Dogs")

ggplot(allows_dogs_df, aes(x = "", y = Percentage, fill = AllowsDogs)) + geom_col(color = "black") + geom_text(aes(label = Labels), position = position_stack(vjust = 0.5)) + coord_polar(theta = "y")

allows_cats_df <- allows_cats_df %>% mutate("Percentage" = Frequency/sum(Frequency))
allows_cats_df <- allows_cats_df %>% mutate("Labels" = Frequency/sum(Frequency)*100)

ggplot(allows_cats_df, aes(x = "", y = Percentage, fill = AllowsCats)) + geom_col(color = "black") + geom_text(aes(label = Labels), position = position_stack(vjust = 0.5)) + coord_polar(theta = "y")
```

### Analysis

#### Price & Square Footage


### Interpretation



### Implications

